# Supabase Database & Configuration

Supabase setup for Auction Chess, providing PostgreSQL database, authentication, and real-time features.

## Services Used

- **Database**: PostgreSQL with Row Level Security (RLS)
- **Authentication**: Email/password + Google OAuth
- **Realtime**: WebSocket-based broadcast channels
- **Storage**: (Not currently used)

## Local Development

### Prerequisites

- [Supabase CLI](https://supabase.com/docs/guides/cli) installed
- Docker running (required by Supabase CLI)

### Starting Supabase

```bash
# From supabase directory or root
supabase start
```

**Services started:**

- API: `http://127.0.0.1:54321`
- Database: `postgresql://postgres:postgres@127.0.0.1:54322/postgres`
- Studio (UI): `http://localhost:54323`
- Inbucket (Email): `http://localhost:54324`

**Important keys displayed:**

- `anon key` - Public key for client-side use
- `service_role key` - Admin key for server-side use

Save these keys to your `.env` files!

### Stopping Supabase

```bash
supabase stop
```

### Restarting Supabase

```bash
# From root
bun run sb:restart

# Or manually
supabase stop && supabase start
```

## Configuration

### Main Configuration File

`supabase/config.toml` contains all Supabase settings:

- **API Settings**: Port, schemas, max rows
- **Database**: PostgreSQL version, port
- **Auth**: OAuth providers, JWT settings, redirect URLs
- **Realtime**: WebSocket configuration
- **Studio**: Local UI port

**Critical settings:**

```toml
[auth]
site_url = "https://<your-domain>.com"
additional_redirect_urls = ["http://localhost:3000", "http://localhost:4173"]

[auth.external.google]
enabled = true
client_id = "<your-google-client-id>"
# secret goes in .env.local
```

### Environment Variables

`supabase/.env.local` (gitignored):

```env
SUPABASE_AUTH_EXTERNAL_GOOGLE_CLIENT_SECRET=<your-google-oauth-secret>
```

**⚠️ Never commit** `.env.local` to git - it contains secrets.

### JWT Signing Keys

`supabase/signing_keys.json` (gitignored):

- Auto-generated by `supabase start`
- Used for local JWT signing
- Each developer needs their own (not shared)
- Uses ES256 algorithm (Elliptic Curve)

## Database Schema

### Tables

**profiles**:

- `id` (uuid, pk) - Links to `auth.users.id`
- `username` (text, unique)
- `bio` (text, nullable)
- `created_at` (timestamp)

**lobbies**:

- `id` (uuid, pk)
- `code` (text, unique) - 6-character lobby code
- `config` (jsonb) - Game configuration
- `game_state` (jsonb, nullable) - Current game state
- `host_uid` (uuid, fk to profiles)
- `guest_uid` (uuid, nullable, fk to profiles)
- `created_at` (timestamp)

### Row Level Security (RLS)

RLS is enabled on all tables with policies:

**profiles**:

- Users can read all profiles
- Users can only update their own profile
- Users can insert their own profile

**lobbies**:

- Users can read all lobbies
- Users can insert lobbies (becomes host)
- Only host can update/delete lobby

See migrations for full policy definitions.

## Migrations

### Migration Files

Located in `supabase/migrations/`:

1. `20251108074633_create_employees_table.sql` - Test table (later removed)
2. `20251108075555_create_lobbies_table.sql` - Initial lobbies table
3. `20251119211539_setup.sql` - Main setup (profiles + lobbies + RLS)
4. `20251125221702_add_game_state.sql` - Add game_state column
5. `20251225085246_drop_lobbies.sql` - Drop lobbies table

### Creating Migrations

```bash
# 1. Make schema changes in Studio
# http://localhost:54323

# 2. Generate migration diff
bun run db:diff

# 3. Review the diff output

# 4. Save migration to file
bun run db:save <migration_name>

# 5. Review generated SQL in supabase/migrations/

# 6. Test migration
bun run db:test
```

### Applying Migrations

**Local:**

```bash
# Reset database and apply all migrations
supabase db reset

# Or just run new migrations
supabase db push --local
```

**Production:**

```bash
# Preview changes (dry-run)
bun run deploy:preview

# Deploy to production
bun run deploy:sb
# Or manually: supabase db push
```

## Type Generation

### Generating TypeScript Types

After any schema change:

```bash
supabase gen types typescript --local > shared/database.types.ts
```

This generates TypeScript types from your database schema:

```typescript
// shared/database.types.ts
export type Database = {
  public: {
    Tables: {
      profiles: {
        Row: {
          id: string;
          username: string;
          bio: string | null;
          created_at: string;
        };
        Insert: {
          id: string;
          username: string;
          bio?: string | null;
        };
        Update: {
          username?: string;
          bio?: string | null;
        };
      };
      // ...
    };
  };
};
```

**⚠️ Important**: This is a **manual step** not automated in deployment.

## Authentication

### Google OAuth Setup

1. **Get credentials** from [Google Cloud Console](https://console.cloud.google.com):
   - Create OAuth 2.0 Client
   - Add authorized redirect URIs:
     - `http://127.0.0.1:54321/auth/v1/callback` (local)
     - `https://<your-project>.supabase.co/auth/v1/callback` (production)

2. **Configure in Supabase**:
   - Update `config.toml`:
     ```toml
     [auth.external.google]
     enabled = true
     client_id = "<your-client-id>"
     ```
   - Add to `.env.local`:
     ```env
     SUPABASE_AUTH_EXTERNAL_GOOGLE_CLIENT_SECRET=<your-secret>
     ```

3. **Production**: Set in Supabase Dashboard → Authentication → Providers → Google

### JWT Configuration

```toml
[auth]
jwt_expiry = 3600  # 1 hour
```

JWTs are signed with:

- **Local**: ES256 (Elliptic Curve) via `signing_keys.json`
- **Production**: HS256 (HMAC) via Supabase-managed secret

## Realtime

### Broadcast Channels

Used for lobby updates without database polling:

```typescript
// Subscribe to lobby channel
const channel = supabase.channel(`lobby:${code}`);

channel
  .on("broadcast", { event: "lobby-update" }, (payload) => {
    console.log("Lobby updated:", payload);
  })
  .subscribe();

// Broadcast update
await channel.send({
  type: "broadcast",
  event: "lobby-update",
  payload: { state: newState },
});

// Cleanup
supabase.removeChannel(channel);
```

**Benefits:**

- Real-time without polling
- No database writes for temporary state
- Automatic connection management

## Deployment

### Linking Production Project

```bash
supabase link --project-ref <your-project-id>
```

Project ref stored in `supabase/.temp/project-ref`.

### Deploying Database

```bash
# From root (recommended)
bun run deploy:sb

# Or manually
./scripts/deploy-supabase.sh

# Custom commit message
./scripts/deploy-supabase.sh "Add user profiles"
```

**Process:**

1. Squash merges `main` → `prod/supabase`
2. Pushes to GitHub
3. Runs `supabase db push` (migrations)
4. Runs `supabase config push` (configuration)

See `/DEPLOYMENT.md` for details.

### What Gets Deployed

**Database:**

- All migration files
- Schema changes
- RLS policies
- Functions and triggers

**Configuration:**

- Auth settings (JWT, OAuth)
- Realtime settings
- API settings
- **Not** secrets (those set in dashboard)

## Supabase Studio

Local web UI at `http://localhost:54323`:

- **Table Editor**: View/edit data
- **SQL Editor**: Run queries
- **Database**: View schema
- **Authentication**: Manage users
- **Storage**: File uploads (not used)

**Useful queries:**

```sql
-- View all profiles
SELECT * FROM profiles;

-- View all lobbies with host info
SELECT l.*, p.username as host_username
FROM lobbies l
JOIN profiles p ON l.host_uid = p.id;

-- Test RLS policies
SELECT * FROM lobbies; -- As authenticated user
```

## Common Tasks

### Resetting Local Database

```bash
# Reset to clean state
bun run db:test

# Or
supabase db reset
```

### Viewing Logs

```bash
# Database logs
supabase db logs

# API logs
supabase logs api
```

### Managing Users

```bash
# Via Studio: http://localhost:54323 → Authentication → Users

# Or via SQL:
supabase db psql
\c postgres
SELECT * FROM auth.users;
```

## Troubleshooting

### Supabase Won't Start

```bash
# Check Docker is running
docker ps

# Check ports are free
lsof -i :54321  # API
lsof -i :54322  # Database
lsof -i :54323  # Studio

# Reset Supabase
supabase stop
supabase start
```

### Migration Fails

```bash
# Check migration SQL syntax
cat supabase/migrations/<migration-file>.sql

# Test migration locally first
supabase db reset

# Check error in logs
supabase logs db
```

### Type Generation Fails

```bash
# Ensure Supabase is running
supabase status

# Check database connection
supabase db psql -c "SELECT 1;"

# Regenerate types
supabase gen types typescript --local > shared/database.types.ts
```

### Auth Not Working

1. Check `config.toml` has correct `site_url`
2. Verify redirect URLs include frontend domain
3. Check Google OAuth credentials
4. Verify `.env.local` has Google client secret
5. Check JWT expiry settings

### Realtime Not Working

1. Verify Realtime is enabled in `config.toml`
2. Check channel name matches on client and server
3. Ensure Supabase client is initialized
4. Check browser console for connection errors

## Security Best Practices

- **RLS Policies**: Always enable RLS on tables
- **Service Role Key**: Only use server-side, never expose to client
- **Anon Key**: Safe to use client-side (limited permissions)
- **JWT Signing Keys**: Never commit to git
- **OAuth Secrets**: Store in `.env.local` (gitignored)

## Performance

- **Connection Pooling**: Enabled by default
- **Indexes**: Add for frequently queried columns
- **RLS**: Minimal performance impact with proper indexes
- **Realtime**: Efficient WebSocket connections

## Links

- **Main README**: `/README.md`
- **Deployment Guide**: `/DEPLOYMENT.md`
- **Frontend README**: `/clients/web/README.md`
- **Backend README**: `/server/README.md`
- **Supabase Docs**: https://supabase.com/docs
- **Supabase CLI**: https://supabase.com/docs/guides/cli
- **PostgreSQL Docs**: https://www.postgresql.org/docs/
